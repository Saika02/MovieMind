 # MovieMind 数据库表设计
 
## 设计原则
- 面向毕业设计，结构尽量精简
- 以电影内容与用户互动为核心
- 可支持后续扩展但不强依赖
- 所有表统一包含 is_deleted、created_at、updated_at
 
 ## 核心表
 
 ### 1) users（用户）
 - id
 - username
 - password_hash
 - role（user / admin）
 - avatar_url
 - bio
- is_deleted
 - created_at
 - updated_at

```sql
CREATE TABLE IF NOT EXISTS users (
  id BIGSERIAL PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role INTEGER NOT NULL,
  avatar_url TEXT,
  bio TEXT,
  is_deleted INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON COLUMN users.id IS '用户主键';
COMMENT ON COLUMN users.username IS '登录名';
COMMENT ON COLUMN users.password_hash IS '密码哈希';
COMMENT ON COLUMN users.role IS '角色枚举';
COMMENT ON COLUMN users.avatar_url IS '头像地址';
COMMENT ON COLUMN users.bio IS '简介';
COMMENT ON COLUMN users.is_deleted IS '是否删除';
COMMENT ON COLUMN users.created_at IS '创建时间';
COMMENT ON COLUMN users.updated_at IS '更新时间';
```
 
### 2) movies（电影）
- id（自增）
- tmdb_id
 - title
 - overview
 - genres
 - keywords
 - cast
 - producers
 - release_date
 - runtime
 - production_companies
- tmdb_vote_average
- tmdb_vote_count
- site_vote_average（可选缓存）
- site_vote_count（可选缓存）
 - popularity
 - tagline
 - poster_file
- is_deleted
 - created_at
 - updated_at

```sql
CREATE TABLE IF NOT EXISTS movies (
  id BIGSERIAL PRIMARY KEY,
  tmdb_id BIGINT UNIQUE,
  title TEXT NOT NULL,
  overview TEXT,
  genres TEXT,
  keywords TEXT,
  cast_list TEXT,
  producers TEXT,
  release_date DATE,
  runtime INTEGER,
  production_companies TEXT,
  tmdb_vote_average NUMERIC(4,2),
  tmdb_vote_count INTEGER,
  site_vote_average NUMERIC(4,2),
  site_vote_count INTEGER,
  tagline TEXT,
  poster_file TEXT,
  is_deleted INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
);

COMMENT ON TABLE movies IS '电影';
COMMENT ON COLUMN movies.id IS '电影主键';
COMMENT ON COLUMN movies.tmdb_id IS 'TMDB 标识';
COMMENT ON COLUMN movies.title IS '标题';
COMMENT ON COLUMN movies.overview IS '简介';
COMMENT ON COLUMN movies.genres IS '类型';
COMMENT ON COLUMN movies.keywords IS '关键词';
COMMENT ON COLUMN movies.cast_list IS '演员';
COMMENT ON COLUMN movies.producers IS '制片人';
COMMENT ON COLUMN movies.release_date IS '上映日期';
COMMENT ON COLUMN movies.runtime IS '时长（分钟）';
COMMENT ON COLUMN movies.production_companies IS '出品公司';
COMMENT ON COLUMN movies.tmdb_vote_average IS 'TMDB 平均分';
COMMENT ON COLUMN movies.tmdb_vote_count IS 'TMDB 评分人数';
COMMENT ON COLUMN movies.site_vote_average IS '站内平均分';
COMMENT ON COLUMN movies.site_vote_count IS '站内评分人数';
COMMENT ON COLUMN movies.tagline IS '标语';
COMMENT ON COLUMN movies.poster_file IS '海报文件';
COMMENT ON COLUMN movies.is_deleted IS '是否删除';
COMMENT ON COLUMN movies.created_at IS '创建时间';
COMMENT ON COLUMN movies.updated_at IS '更新时间';
```
 
### 3) reviews（评分+评论）
- id
- user_id
- movie_id
- score
- content
- is_deleted
- created_at
- updated_at

```sql
CREATE TABLE IF NOT EXISTS reviews (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  movie_id BIGINT NOT NULL REFERENCES movies(id),
  score NUMERIC(3,1) NOT NULL,
  content TEXT NOT NULL,
  is_deleted INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX IF NOT EXISTS ux_reviews_user_movie
  ON reviews (user_id, movie_id);

COMMENT ON TABLE reviews IS '评分+评论';
COMMENT ON COLUMN reviews.id IS '记录主键';
COMMENT ON COLUMN reviews.user_id IS '用户';
COMMENT ON COLUMN reviews.movie_id IS '电影';
COMMENT ON COLUMN reviews.score IS '评分值';
COMMENT ON COLUMN reviews.content IS '评论内容';
COMMENT ON COLUMN reviews.is_deleted IS '是否删除';
COMMENT ON COLUMN reviews.created_at IS '创建时间';
COMMENT ON COLUMN reviews.updated_at IS '更新时间';
COMMENT ON INDEX ux_reviews_user_movie IS '用户对同一电影仅一次评价';
```

### 4) favorites（收藏/想看）
 - id
 - user_id
 - movie_id
- is_deleted
 - created_at
- updated_at

```sql
CREATE TABLE IF NOT EXISTS favorites (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  movie_id BIGINT NOT NULL REFERENCES movies(id),
  is_deleted INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

COMMENT ON TABLE favorites IS '收藏/想看';
COMMENT ON COLUMN favorites.id IS '收藏主键';
COMMENT ON COLUMN favorites.user_id IS '操作用户';
COMMENT ON COLUMN favorites.movie_id IS '关联电影';
COMMENT ON COLUMN favorites.is_deleted IS '是否删除';
COMMENT ON COLUMN favorites.created_at IS '创建时间';
COMMENT ON COLUMN favorites.updated_at IS '更新时间';
```
 
 ## 管理表
 
### 5) admins（管理员操作记录）
 - id
 - admin_id
 - action
 - target_type
 - target_id
- is_deleted
 - created_at
- updated_at

```sql
CREATE TABLE IF NOT EXISTS admins (
  id BIGSERIAL PRIMARY KEY,
  admin_id BIGINT NOT NULL REFERENCES users(id),
  action TEXT NOT NULL,
  target_type INTEGER,
  target_id BIGINT,
  is_deleted INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

COMMENT ON TABLE admins IS '管理员操作记录';
COMMENT ON COLUMN admins.id IS '操作记录主键';
COMMENT ON COLUMN admins.admin_id IS '管理员用户';
COMMENT ON COLUMN admins.action IS '操作描述';
COMMENT ON COLUMN admins.target_type IS '目标类型枚举';
COMMENT ON COLUMN admins.target_id IS '目标标识';
COMMENT ON COLUMN admins.is_deleted IS '是否删除';
COMMENT ON COLUMN admins.created_at IS '创建时间';
COMMENT ON COLUMN admins.updated_at IS '更新时间';
```
 
 ## 可选扩展表（后续实现）
 
### 6) user_history（浏览记录）
 - id
 - user_id
 - movie_id
 - last_viewed_at
- is_deleted
- created_at
- updated_at
 
### 7) chat_sessions（智能体会话）
 - id
 - user_id
 - title
 - created_at
- updated_at
 - role（user / assistant）
 - content
- is_deleted
- created_at
- updated_at

## 向量检索表（pgvector）

### 8) movie_embeddings（多类型向量）
- id
- movie_id
- content_type
- content_id
- embedding
- model_name
- is_deleted
- created_at
- updated_at

```sql
CREATE TABLE IF NOT EXISTS movie_embeddings (
  id BIGSERIAL PRIMARY KEY,
  movie_id BIGINT NOT NULL REFERENCES movies(id),
  content_type INTEGER NOT NULL,
  content_id BIGINT,
  embedding VECTOR(1024) NOT NULL,
  model_name TEXT NOT NULL,
  is_deleted INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_movie_embeddings_movie_id
  ON movie_embeddings (movie_id);

CREATE INDEX IF NOT EXISTS idx_movie_embeddings_content_type
  ON movie_embeddings (content_type);

CREATE INDEX IF NOT EXISTS idx_movie_embeddings_embedding_ivfflat
  ON movie_embeddings
  USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 100);

COMMENT ON TABLE movie_embeddings IS '多类型向量';
COMMENT ON COLUMN movie_embeddings.id IS '向量主键';
COMMENT ON COLUMN movie_embeddings.movie_id IS '关联电影';
COMMENT ON COLUMN movie_embeddings.content_type IS '内容类型枚举';
COMMENT ON COLUMN movie_embeddings.content_id IS '内容主键';
COMMENT ON COLUMN movie_embeddings.embedding IS '向量';
COMMENT ON COLUMN movie_embeddings.model_name IS '向量模型';
COMMENT ON COLUMN movie_embeddings.is_deleted IS '是否删除';
COMMENT ON COLUMN movie_embeddings.created_at IS '创建时间';
COMMENT ON COLUMN movie_embeddings.updated_at IS '更新时间';
COMMENT ON INDEX idx_movie_embeddings_movie_id IS '电影查询';
COMMENT ON INDEX idx_movie_embeddings_content_type IS '类型过滤';
COMMENT ON INDEX idx_movie_embeddings_embedding_ivfflat IS '余弦近似检索索引';
```
